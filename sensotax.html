<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensotax | Sensorisk Taxonomi</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sensotax">
    <link rel="manifest" href="/sensotax-pwa/manifest.webmanifest">
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
            padding: 15px;
        }
        .niva1 {
            padding: 12px;
            margin-top: 15px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 1.2em;
            font-weight: bold;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
        }
        .niva1-icon {
            font-size: 1.4em;
            margin-right: 10px;
        }
        .niva2 {
            background-color: #ffffff;
            color: #333;
            padding: 10px 15px;
            margin-top: 3px;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
            font-weight: 600;
            transition: background-color 0.1s;
        }
        .niva2:hover {
            background-color: #f0f0f0;
        }
        .niva3 {
            list-style-type: none;
            margin: 0;
            padding: 5px 20px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-top: none;
            padding: 10px 15px;
            font-size: 0.9em;
        }
        .niva3 li {
            padding: 3px 0;
            border-bottom: 1px dotted #eee;
        }
        .niva3 li:last-child {
            border-bottom: none;
        }
        .rubrik {
            text-align: center;
            color: #2a6fdb;
            margin-bottom: 30px;
        }
        /* Styling för Nivå 2 border (använder CSS-variabel) */
        .niva2-container {
            border-left: 5px solid var(--niva1-color);
        }
    </style>
</head>
<body>

<div class="rubrik">
    <h1>ÖL SENSORISK TAXONOMI</h1>
    <p>Data hämtas från extern YAML-fil...</p>
</div>

<div id="taxonomi-container">
    </div>

<script>
// =================================================================
// 1. YAML PARSER: Inbäddad kod för att konvertera YAML till JavaScript
// Detta är nödvändigt eftersom webbläsare inte kan läsa YAML direkt.
// Kod baserad på en kompakt, klientsides YAML-parser.
// =================================================================

function parseYAML(yaml) {
    // Förenklad parser som hanterar grundläggande YAML-listor och objekt (som vår struktur)
    const lines = yaml.split('\n');
    let output = {};
    let stack = [];
    let currentObject = output;

    lines.forEach(line => {
        line = line.replace(/#.*$/, '').trimEnd(); // Ta bort kommentarer och trimma
        if (!line) return;

        const indent = line.search(/\S/);
        const trimmedLine = line.trimStart();
        const level = indent / 2; // Går ut från 2 mellanslag per indent

        while (stack.length > level) {
            stack.pop();
            currentObject = stack.length > 0 ? stack[stack.length - 1].ref : output;
        }
        
        const isListItem = trimmedLine.startsWith('-');
        
        if (isListItem) {
            let keyMatch = trimmedLine.substring(1).trimStart().match(/^(\w+):\s*(.*)/);
            if (keyMatch) { // Hanterar objekt i listor (t.ex. - namn: Citrus)
                let newObj = { [keyMatch[1]]: keyMatch[2].trim() };
                currentObject.push(newObj);
                stack.push({ level, key: keyMatch[1], ref: newObj });
                currentObject = newObj;
            } else if (trimmedLine === '-') { // Hanterar start av ny Nivå 1-post (list of objects)
                 if (!Array.isArray(currentObject)) {
                    const parentKey = Object.keys(currentObject).pop();
                    currentObject = currentObject[parentKey] = [];
                 }
                let newObj = {};
                currentObject.push(newObj);
                stack.push({ level, ref: newObj });
                currentObject = newObj;
            } else { // Hanterar enkla listelement (termer)
                if (!Array.isArray(currentObject)) {
                    const parentKey = Object.keys(currentObject).pop();
                    currentObject = currentObject[parentKey] = [];
                }
                currentObject.push(trimmedLine.substring(1).trimStart());
            }
        } else {
            let parts = trimmedLine.match(/^(.+?):\s*(.*)/);
            if (parts) {
                let key = parts[1].trim();
                let value = parts[2].trim();
                
                if (value === '') { // Nytt objekt eller lista startar
                    let newRef = Array.isArray(currentObject) ? {} : {};
                    if(Array.isArray(currentObject)) {
                        currentObject[currentObject.length - 1][key] = newRef;
                    } else {
                        currentObject[key] = newRef;
                    }
                    stack.push({ level, key, ref: newRef });
                    currentObject = newRef;
                } else { // Enkelt nyckel/värde-par
                    currentObject[key] = value;
                }
            }
        }
    });

    // Enkel fix för att få ut 'taxonomi'-listan
    return output.taxonomi || output; 
}


// =================================================================
// 2. DATAHÄMTNING OCH GRÄNSSNITTSBYGGANDE
// =================================================================

const container = document.getElementById('taxonomi-container');
const rubrik = document.querySelector('.rubrik p');

async function loadAndRender() {
    try {
        rubrik.textContent = "Laddar taxonomidata...";
        
        // 1. Hämta YAML-filen
        const response = await fetch('./taxonomi.yaml');
        if (!response.ok) {
             throw new Error(`Kunde inte ladda data: ${response.statusText}`);
        }
        const yamlText = await response.text();

        // 2. Parsa YAML till JavaScript-objekt
        const taxonomyData = parseYAML(yamlText);
        
        // 3. Rendra gränssnittet
        renderTaxonomy(taxonomyData);
        
    } catch (error) {
        console.error("Fel vid laddning eller rendering:", error);
        rubrik.textContent = `FEL: Kunde inte ladda taxonomi. (${error.message})`;
        container.innerHTML = `<p style="color: red;">Kontrollera att 'taxonomi.yaml' ligger i roten och att PWA-cachen rensats.</p>`;
    }
}

function renderTaxonomy(data) {
    if (!Array.isArray(data)) {
        throw new Error("Taxonomidata är felaktigt formaterad (Måste vara en lista).");
    }

    container.innerHTML = '';
    rubrik.textContent = "Klar för bedömning.";

    data.forEach(niva1 => {
        // Skapa Nivå 1-element
        const niva1Div = document.createElement('div');
        niva1Div.className = 'niva1';
        niva1Div.style.backgroundColor = niva1.color;
        
        const iconSpan = document.createElement('span');
        iconSpan.className = 'niva1-icon';
        iconSpan.textContent = niva1.icon;
        niva1Div.appendChild(iconSpan);
        
        niva1Div.appendChild(document.createTextNode(`${niva1.id}. ${niva1.namn}`));
        container.appendChild(niva1Div);

        // Skapa container för Nivå 2-kategorier (Visibel som standard)
        const niva2Container = document.createElement('div');
        niva2Container.className = 'niva2-container';
        // Sätt CSS-variabeln för Nivå 2 border
        niva2Container.style.setProperty('--niva1-color', niva1.color);
        niva2Container.style.display = 'block'; 
        container.appendChild(niva2Container);

        // Rendra Nivå 2 och 3
        if (Array.isArray(niva1.kategorier)) {
            niva1.kategorier.forEach(niva2 => {
                const niva2Div = document.createElement('div');
                niva2Div.className = 'niva2';
                niva2Div.textContent = niva2.namn;
                niva2Container.appendChild(niva2Div);

                const niva3Ul = document.createElement('ul');
                niva3Ul.className = 'niva3';
                niva3Ul.style.display = 'none'; // Nivå 3 är dold som standard
                
                if (Array.isArray(niva2.termer)) {
                    niva2.termer.forEach(term => {
                        const li = document.createElement('li');
                        li.textContent = term;
                        niva3Ul.appendChild(li);
                    });
                }
                niva2Container.appendChild(niva3Ul);

                // Klickhändelse för Nivå 2 (visar/döljer Nivå 3)
                niva2Div.addEventListener('click', function() {
                    const nextNiva3 = this.nextElementSibling;
                    if (nextNiva3 && nextNiva3.classList.contains('niva3')) {
                        nextNiva3.style.display = nextNiva3.style.display === 'none' ? 'block' : 'none';
                    }
                });
            });
        }

        // Klickhändelse för Nivå 1 (visar/döljer Nivå 2-containern)
        niva1Div.addEventListener('click', function() {
            const nextContainer = this.nextElementSibling;
            if (nextContainer) {
                const isHidden = nextContainer.style.display === 'none';
                nextContainer.style.display = isHidden ? 'block' : 'none';
                
                // Om Nivå 1 döljs, dölj även alla Nivå 3-listor i den
                if (!isHidden) {
                    nextContainer.querySelectorAll('.niva3').forEach(ul => {
                        ul.style.display = 'none';
                    });
                }
            }
        });
    });
}

// Starta laddningen
loadAndRender();

// =================================================================
// 3. SERVICE WORKER REGISTRERING (Ligger här för att använda load-event)
// =================================================================
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        // Kontrollera att sökvägen till SW är korrekt för GitHub Pages
        navigator.serviceWorker.register('/sensotax-pwa/service-worker.js') 
            .then(registration => {
                console.log('SW registrerad:', registration);
            })
            .catch(error => {
                console.error('SW registrering misslyckades:', error);
            });
    });
}
</script>

</body>
</html>